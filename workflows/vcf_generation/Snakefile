import os
from pathlib import Path

# Load config
configfile: "config_vcf.yaml"

# Set paths
WORKFLOW_DIR = Path(workflow.basedir)

# Define directories based on config
REFERENCE_GENOME_DIR = Path(config["reference_genome_dir"]).resolve()
VARIANT_DATA_DIR = Path(config["variant_data_dir"]).resolve()
OUTPUT_DIR = Path("results/vcf_output").resolve()

# Create output directories
OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
(OUTPUT_DIR / "logs").mkdir(parents=True, exist_ok=True)
(OUTPUT_DIR / "vg_graphs").mkdir(parents=True, exist_ok=True)
(OUTPUT_DIR / "vcf").mkdir(parents=True, exist_ok=True)

# Docker image
VG_DOCKER = "quay.io/vgteam/vg:v1.65.0"

# Get current user ID and group ID for Docker
USER_ID = os.getuid()
GROUP_ID = os.getgid()

# Get sample names from config
NUM_SAMPLES = config["num_samples"]
SAMPLES = [f"sample_{i:03d}" for i in range(NUM_SAMPLES)]

print(f"Reference genome directory: {REFERENCE_GENOME_DIR}")
print(f"Variant data directory: {VARIANT_DATA_DIR}")
print(f"Output directory: {OUTPUT_DIR}")
print(f"Samples to process: {SAMPLES}")
print(f"Running as user: {USER_ID}:{GROUP_ID}")

# Final outputs
rule all:
    input:
        # Ensure reference genome is generated
        REFERENCE_GENOME_DIR / "reference.fasta",
        # Ensure all variant data (haplotype fastas) are generated
        expand(VARIANT_DATA_DIR / "{sample}" / "{sample}_hap1.fasta", sample=SAMPLES),
        expand(VARIANT_DATA_DIR / "{sample}" / "{sample}_hap2.fasta", sample=SAMPLES),
        # Ensure all per-sample VCFs are generated
        expand(OUTPUT_DIR / "vcf" / "{sample}.vcf.gz", sample=SAMPLES)

# Rule to generate the reference genome
rule generate_reference_genome:
    output:
        fasta=REFERENCE_GENOME_DIR / "reference.fasta"
    log:
        OUTPUT_DIR / "logs" / "generate_reference_genome.log"
    params:
        num_chromosomes=config["num_chromosomes"],
        chr_length=config["base_length"],
        length_decay=config["decay"],
        gc_content=config["gc_content"],
        seed=config["seed"]
    shell:
        "python scripts/test_data/generate_reference_genome.py "
        "--num-chromosomes {params.num_chromosomes} "
        "--chr-length {params.chr_length} "
        "--length-decay {params.length_decay} "
        "--gc-content {params.gc_content} "
        "--output {output.fasta} "
        "--seed {params.seed} > {log} 2>&1"

# Rule to generate variant data (haplotype FASTAs and JSONs)
rule generate_variant_data:
    input:
        reference=REFERENCE_GENOME_DIR / "reference.fasta"
    output:
        # Use a sentinel file to indicate completion of all variant data generation
        touch(VARIANT_DATA_DIR / ".variants_generated_complete")
    params:
        num_samples=config["num_samples"],
        variants_per_haplotype=config["variants_per_haplotype"],
        output_dir=VARIANT_DATA_DIR,
        variant_types="snv,insertion,deletion",
        seed=config["seed"]
    log:
        OUTPUT_DIR / "logs" / "generate_variant_data.log"
    shell:
        "python scripts/test_data/generate_variants.py "
        "--reference {input.reference} "
        "--num-samples {params.num_samples} "
        "--variants-per-haplotype {params.variants_per_haplotype} "
        "--output-dir {params.output_dir} "
        "--variant-types {params.variant_types} "
        "--seed {params.seed} > {log} 2>&1"

# Rule to build a vg graph for a diploid sample
# This graph will contain the reference path and two haplotype paths
rule build_sample_graph:
    input:
        reference=REFERENCE_GENOME_DIR / "reference.fasta",
        hap1=VARIANT_DATA_DIR / "{sample}" / "{sample}_hap1.fasta",
        hap2=VARIANT_DATA_DIR / "{sample}" / "{sample}_hap2.fasta"
    output:
        graph=OUTPUT_DIR / "vg_graphs" / "{sample}.vg"
    log:
        OUTPUT_DIR / "logs" / "build_graph_{sample}.log"
    params:
        mount_dir=str(WORKFLOW_DIR.parent.parent.absolute()),
        user_id=USER_ID,
        group_id=GROUP_ID,
        # Paths relative to mount_dir for docker
        ref_path_docker=str(REFERENCE_GENOME_DIR.relative_to(WORKFLOW_DIR.parent.parent.absolute()) / "reference.fasta"),
        hap1_path_docker=str(VARIANT_DATA_DIR.relative_to(WORKFLOW_DIR.parent.parent.absolute()) / "{sample}" / "{sample}_hap1.fasta"),
        hap2_path_docker=str(VARIANT_DATA_DIR.relative_to(WORKFLOW_DIR.parent.parent.absolute()) / "{sample}" / "{sample}_hap2.fasta"),
        graph_path_docker=str(OUTPUT_DIR.relative_to(WORKFLOW_DIR.parent.parent.absolute()) / "vg_graphs" / "{sample}.vg")
    threads: config["threads"]
    shell:
        """
        echo "Building graph for {wildcards.sample}..." > {log}
        docker run --rm \
            --user {params.user_id}:{params.group_id} \
            -v {params.mount_dir}:/data \
            -w /data \
            {VG_DOCKER} \
            vg construct -r {params.ref_path_docker} \
                         -v {params.hap1_path_docker} \
                         -v {params.hap2_path_docker} \
                         -p -m -a \
                         -t {threads} \
                         > {params.graph_path_docker} 2>> {log}
        """

# Rule to call variants from the sample graph
rule call_variants:
    input:
        graph=OUTPUT_DIR / "vg_graphs" / "{sample}.vg",
        reference=REFERENCE_GENOME_DIR / "reference.fasta"
    output:
        vcf=OUTPUT_DIR / "vcf" / "{sample}.vcf.gz"
    log:
        OUTPUT_DIR / "logs" / "call_variants_{sample}.log"
    params:
        mount_dir=str(WORKFLOW_DIR.parent.parent.absolute()),
        user_id=USER_ID,
        group_id=GROUP_ID,
        # Paths relative to mount_dir for docker
        graph_path_docker=str(OUTPUT_DIR.relative_to(WORKFLOW_DIR.parent.parent.absolute()) / "vg_graphs" / "{sample}.vg"),
        ref_path_docker=str(REFERENCE_GENOME_DIR.relative_to(WORKFLOW_DIR.parent.parent.absolute()) / "reference.fasta"),
        vcf_path_docker=str(OUTPUT_DIR.relative_to(WORKFLOW_DIR.parent.parent.absolute()) / "vcf" / "{sample}.vcf.gz")
    threads: config["threads"]
    shell:
        """
        echo "Calling variants for {wildcards.sample}..." > {log}
        docker run --rm \
            --user {params.user_id}:{params.group_id} \
            -v {params.mount_dir}:/data \
            -w /data \
            {VG_DOCKER} \
            vg call {params.graph_path_docker} \
                    -r {params.ref_path_docker} \
                    -k 16 \
                    -s {wildcards.sample} \
                    -P \
                    -t {threads} \
                    | bgzip > {params.vcf_path_docker} 2>> {log}
        """
